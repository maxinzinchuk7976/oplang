; 0x00-0x08 envoriment
; 0x08-0x10 size
; 0x10-0x18 buffer
; 0x18-0x20 rbp
&fn_tokenize ; rdi envoriment, rsi buffer, rdx size
4851
4857
    c8 2000 00 ; enter 0x20,0
        48893c24 ; mov [rsp], rdi
        4889742410 ; mov [rsp+0x10], rsi
        4889542408 ; mov [rsp+0x08], rdx

        4833c9 ; xor rcx, rcx
        &fn_tokenize_loop
            3b ca ; cmp ecx, rdx
            0f8d*fn_tokenize_end
            8a040e ; mov al, [rcx+rsi]
            488d3d*var_hex_l
            488d15*var_hex_h
            e8*fn_2chrsrch
            488b742410 ; mov rsi, [rsp+0x10]
            488b542408 ; mov rdx, [rsp+0x08]
            488b3c24 ; mov rdi, [rsp]
            751*fn_tokenize_command
                e8*fn_token_hex
                eb1*fn_tokenize_loop
            &fn_tokenize_command
            803c0e"%" ; cmp [rcx+rsi], 0x25
            751*fn_tokenize_bracket
                e8*fn_token_command
                48893c24 ; mov [rsp], rdi
                eb1*fn_tokenize_loop
            &fn_tokenize_bracket
            803c0e"}" ; cmp [rcx+rsi], 0x7d
            751*fn_tokenize_annotation
                e8*fn_token_bracket
                48893c24 ; mov [rsp], rdi
                eb1*fn_tokenize_loop
            &fn_tokenize_annotation
            803c0e";" ; cmp [rcx+rsi], ';'
            751*fn_tokenize_label
                e8*fn_token_annotation
                eb1*fn_tokenize_loop
            &fn_tokenize_label
            803c0e"&" ; cmp [rcx+rsi], '&'
            751*fn_tokenize_relative
                e8*fn_token_label
                e9*fn_tokenize_loop
            &fn_tokenize_relative
            803c0e"*" ; cmp [rcx+rsi], '*'
            751*fn_tokenize_string
                b004
                e8*fn_token_relative
                e9*fn_tokenize_loop
            &fn_tokenize_string
            803c0e22  ; cmp [rcx+rsi], '"'
            751*fn_tokenize_default
                e8*fn_token_string
                e9*fn_tokenize_loop
            &fn_tokenize_default
            ffc1 ; inc rcx
        e9*fn_tokenize_loop
        &fn_tokenize_end

    c9
485f
4859
c3


&fn_tokenize_string_read  ; rsi buffer, rcx position, rdx size
4853
4856
4857
    488bda ; mov rbx, rdx
    4833ff ; xor rdi, rdi
    &fn_tokenize_string_read_loop1
        3b ca ; cmp ecx, rdx
        7d 1*fn_tokenize_string_read_end
        8a040e ; mov al, [rcx+rsi]
        ffc1 ;inc rcx
        4852 
            488d15 *var_fillers
            e8*fn_chrcmp
        485a
    741*fn_tokenize_string_read_loop1
    &fn_tokenize_string_read_done1
    ffcf ; dec rdi
    &fn_tokenize_string_read_loop2
        3b ca ; cmp ecx, rdx
        7d 1*fn_tokenize_string_read_done2
        8a040e ; mov al, [rcx+rsi]
        ffc1 ;inc rcx
        ffc7 ;inc rdi
        4852 
            488d15 *var_delimiters
            e8*fn_chrcmp
        485a
    751*fn_tokenize_string_read_loop2
    &fn_tokenize_string_read_done2
    ffc7 ; inc rdi
    ffc9 ; dev rcx
    4080ff00 ; cmp rdi, 00
    751*fn_tokenize_string_read_len_isset
        48b8 ffffffffffffffff
        eb1*fn_tokenize_string_read_end
    &fn_tokenize_string_read_len_isset
    4803f1 ; add rsi, rcx
    482bf7 ; sub rsi, rdi

    e8*fn_nstrcpy

    &fn_tokenize_string_read_end

485f
485e
485b
c3

%include src/token/hex.op
%include src/token/command.op
%include src/token/bracket.op
%include src/token/annotation.op
%include src/token/label.op
%include src/token/relative.op
%include src/token/string.op

&var_hex_l "0123456789abcdef" 00
&var_hex_h "0123456789ABCDEF" 00
&var_delimiters ">)%&;*} " 0a0900
&var_fillers 200900
